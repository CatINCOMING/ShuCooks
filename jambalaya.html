<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jambalaya Recipe - ShuCooks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #fafafa;
        }
        .navbar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: #ffffffcc;
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .navbar a {
            padding: 10px 20px;
            background: #f2f2f2;
            border-radius: 20px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: 0.2s;
        }
        .navbar a:hover {
            background: #ffd6a5;
        }
        .navbar .logo {
            background: #ffd6a5;
        }
        .content {
            padding: 30px;
            max-width: 900px;
            margin: auto;
        }
        .recipe-photo {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 14px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 18px;
            border: none;
            background: #ffe5b4;
            border-radius: 14px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #ffc988;
        }
        .chef-on {
            background: #8fd694 !important;
        }
        h1 {
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
        }
        ul, ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        li {
            margin-bottom: 8px;
        }
        .ingredient-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }
        .ingredient-item:hover {
            background: #f0f0f0;
        }
        .ingredient-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .ingredient-item.checked {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .chef-mode-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a1a;
            color: white;
            z-index: 1000;
            overflow-y: auto;
        }
        .chef-mode-container.active {
            display: block;
        }
        .chef-mode-header {
            background: #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chef-mode-header h2 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .exit-chef-mode {
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .chef-mode-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .progress-bar {
            background: #333;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            background: #8fd694;
            height: 100%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .current-step {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 14px;
            margin-bottom: 20px;
            border: 3px solid #8fd694;
            cursor: pointer;
            transition: 0.2s;
        }
        .current-step:active {
            transform: scale(0.98);
        }
        .step-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #8fd694;
        }
        .step-text {
            font-size: 24px;
            line-height: 1.6;
        }
        .timer-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #8fd694;
            margin: 20px 0;
        }
        .timer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .timer-buttons button {
            background: #444;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
        }
        .timer-buttons button:hover {
            background: #555;
        }
        .chef-navigation {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .chef-navigation button {
            flex: 1;
            padding: 18px;
            font-size: 18px;
            background: #444;
            color: white;
        }
        .chef-navigation button:hover {
            background: #555;
        }
        .chef-navigation button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .all-steps-preview {
            margin-top: 30px;
        }
        .step-preview {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0.5;
            cursor: pointer;
            transition: 0.2s;
        }
        .step-preview:hover {
            opacity: 0.8;
        }
        .step-preview.completed {
            opacity: 0.3;
            text-decoration: line-through;
        }
        .step-preview.active {
            opacity: 1;
            border: 2px solid #8fd694;
        }
        .ingredients-toggle {
            background: #444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .ingredients-list {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .ingredients-list ul {
            list-style: none;
            margin: 0;
        }
        .chef-ingredient-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
            cursor: pointer;
            transition: 0.2s;
        }
        .chef-ingredient-item:hover {
            background: #333;
        }
        .chef-ingredient-item input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .chef-ingredient-item.checked {
            text-decoration: line-through;
            opacity: 0.5;
        }
        .voice-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #8fd694;
            color: #1a1a1a;
            padding: 15px 20px;
            border-radius: 30px;
            font-weight: bold;
            animation: pulse 2s infinite;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .voice-indicator.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .hands-free-badge {
            display: inline-block;
            background: #8fd694;
            color: #1a1a1a;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        #voiceStatus {
            display: inline-block;
            background: #ffc988;
            color: #1a1a1a;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        #voiceStatus:hover {
            opacity: 0.8;
        }
        .ai-timer-btn {
            background: #8fd694 !important;
            color: #1a1a1a;
            font-weight: bold;
        }
        .ai-timer-btn:hover {
            background: #7ac682 !important;
        }
        .commands-help {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .commands-help h3 {
            color: #8fd694;
            margin-bottom: 15px;
        }
        .commands-help ul {
            list-style: none;
            margin: 0;
        }
        .commands-help li {
            padding: 8px 0;
            color: #ccc;
        }
        .commands-help code {
            background: #1a1a1a;
            padding: 3px 8px;
            border-radius: 4px;
            color: #8fd694;
        }
    </style>
</head>
<body>
<nav class="navbar">
    <a href="#" class="logo">ShuCooks</a>
    <a href="#">Home</a>
    <a href="#">Recipes</a>
    <a href="#">Contact</a>
</nav>

<section class="content">
    <h1>Jambalaya (CPK-Style)</h1>
    <div class="recipe-photo">Jambalaya Photo</div>
    
    <div class="button-row">
        <button onclick="printRecipe()">üñ®Ô∏è Print Recipe</button>
        <button id="chefBtn" onclick="toggleChefMode()">üë®‚Äçüç≥ Chef Mode</button>
    </div>
    
    <h2>Ingredients (Serves 4)</h2>
    <div id="ingredientsList">
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>3 tbsp Cajun spice</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>12‚Äì16 shrimp, deveined</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>¬Ω red bell pepper, diced</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>1 jalape√±o, diced</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>¬Ω red onion, diced</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>¬Ω lb cooked linguine</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>1 andouille sausage, sliced</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>1 ¬Ω cups chicken stock</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>1 tbsp tomato sauce</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>¬Ω tsp salt</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>¬º tsp black pepper</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>3 cloves garlic, minced</span>
        </div>
        <div class="ingredient-item" onclick="toggleIngredient(this)">
            <input type="checkbox">
            <span>3 tbsp cooking oil</span>
        </div>
    </div>
    
    <h2>Instructions</h2>
    <ol id="instructionsList">
        <li><strong>Season the vegetables:</strong> Mix peppers, onion, garlic, Cajun seasoning, and pepper.</li>
        <li><strong>Sear the shrimp:</strong> Cook 30‚Äì60 seconds per side.</li>
        <li><strong>Cook the sausage:</strong> Saut√© 1 minute.</li>
        <li><strong>Cook the vegetables:</strong> Sear 3‚Äì4 minutes.</li>
        <li><strong>Build the sauce:</strong> Add stock + tomato sauce, simmer 5 minutes.</li>
        <li><strong>Add pasta:</strong> Toss 2‚Äì3 minutes until coated.</li>
    </ol>
</section>

<!-- Chef Mode Container -->
<div id="chefModeContainer" class="chef-mode-container">
    <div class="chef-mode-header">
        <h2>
            <span>üë®‚Äçüç≥ Chef Mode</span>
            <span class="hands-free-badge">üîì Screen Unlocked</span>
            <span id="voiceStatus" onclick="retryVoice()">üé§ Starting...</span>
        </h2>
        <button class="exit-chef-mode" onclick="toggleChefMode()">‚úï Exit</button>
    </div>
    
    <div class="chef-mode-content">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Step 1 of 6</div>
        
        <div class="ingredients-toggle" onclick="toggleIngredientsView()">
            <strong>üìã Ingredients Checklist</strong> <span id="ingredientsToggleIcon">‚ñº</span>
        </div>
        <div class="ingredients-list" id="chefIngredientsList" style="display: none;">
            <div id="chefIngredientsContent"></div>
        </div>
        
        <div class="current-step" id="currentStep" onclick="nextStep()">
            <div class="step-title" id="stepTitle">Step 1: Season the vegetables</div>
            <div class="step-text" id="stepText">Mix peppers, onion, garlic, Cajun seasoning, and pepper.</div>
            
            <div class="timer-section" id="timerSection" style="display: none;">
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="timer-buttons">
                    <button onclick="startTimer(60)">1 min</button>
                    <button onclick="startTimer(180)">3 min</button>
                    <button onclick="startTimer(300)">5 min</button>
                    <button onclick="pauseTimer()">‚è∏ Pause</button>
                    <button onclick="resetTimer()">üîÑ Reset</button>
                </div>
            </div>
        </div>
        
        <div class="chef-navigation">
            <button onclick="prevStep()" id="prevBtn">‚¨ÖÔ∏è Previous</button>
            <button onclick="nextStep()" id="nextBtn">Next ‚û°Ô∏è</button>
        </div>
        
        <div class="all-steps-preview">
            <h3>All Steps</h3>
            <div id="stepsPreview"></div>
        </div>
        
        <div class="commands-help">
            <h3>üé§ AI Voice Commands (say anything natural!)</h3>
            <ul>
                <li><code>"next step"</code> or <code>"continue"</code> or <code>"go forward"</code></li>
                <li><code>"go back"</code> or <code>"previous step"</code></li>
                <li><code>"what are the first 2 ingredients"</code></li>
                <li><code>"check off the shrimp"</code> or <code>"mark ingredient 2"</code></li>
                <li><code>"start the timer"</code> or <code>"set a timer"</code></li>
                <li><code>"repeat that"</code> or <code>"say that again"</code></li>
                <li><code>"show ingredients"</code> or <code>"hide ingredients"</code></li>
                <li><code>"go to step 3"</code> or <code>"jump to step 5"</code></li>
            </ul>
            <p style="margin-top: 10px; color: #8fd694;">‚ú® The AI understands natural language - just speak normally!</p>
        </div>
    </div>
</div>

<div class="voice-indicator" id="voiceIndicator">
    üé§ Listening...
</div>

<script>
    const steps = [
        { title: "Season the vegetables", text: "Mix peppers, onion, garlic, Cajun seasoning, and pepper." },
        { title: "Sear the shrimp", text: "Cook 30‚Äì60 seconds per side." },
        { title: "Cook the sausage", text: "Saut√© 1 minute." },
        { title: "Cook the vegetables", text: "Sear 3‚Äì4 minutes." },
        { title: "Build the sauce", text: "Add stock + tomato sauce, simmer 5 minutes." },
        { title: "Add pasta", text: "Toss 2‚Äì3 minutes until coated." }
    ];
    
    let currentStepIndex = 0;
    let chefMode = false;
    let wakeLock = null;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;
    let recognition = null;
    let ingredientsVisible = false;
    let detectedTimers = {};
    let videoWakeLock = null;
    
    // Fallback wake lock using video element
    function enableVideoWakeLock() {
        if (!videoWakeLock) {
            videoWakeLock = document.createElement('video');
            videoWakeLock.setAttribute('loop', '');
            videoWakeLock.setAttribute('muted', '');
            videoWakeLock.setAttribute('playsinline', '');
            videoWakeLock.style.position = 'fixed';
            videoWakeLock.style.opacity = '0';
            videoWakeLock.style.pointerEvents = 'none';
            videoWakeLock.style.width = '1px';
            videoWakeLock.style.height = '1px';
            
            const canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = 1;
            const ctx = canvas.getContext('2d');
            ctx.fillRect(0, 0, 1, 1);
            
            canvas.toBlob(blob => {
                videoWakeLock.src = URL.createObjectURL(blob);
                videoWakeLock.play().catch(e => console.log('Video fallback failed:', e));
            });
            
            document.body.appendChild(videoWakeLock);
        }
    }
    
    function disableVideoWakeLock() {
        if (videoWakeLock) {
            videoWakeLock.pause();
            videoWakeLock.remove();
            videoWakeLock = null;
        }
    }
    
    // AI Timer Detection Function
    async function detectTimersInSteps() {
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            const combinedText = step.title + ". " + step.text;
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `Extract time durations from this cooking step. Return ONLY valid JSON:
{"timers": [{"duration_seconds": 45, "label": "30-60 sec (avg)"}]}

If no times mentioned, return {"timers": []}

Step: "${combinedText}"

Rules: For ranges use average, for "per side" multiply by 2, convert to seconds`
                        }]
                    })
                });
                
                const data = await response.json();
                const text = data.content[0].text.trim();
                const cleanText = text.replace(/```json|```/g, "").trim();
                const result = JSON.parse(cleanText);
                
                if (result.timers && result.timers.length > 0) {
                    detectedTimers[i] = result.timers;
                }
            } catch (err) {
                console.error(`AI detection failed for step ${i}:`, err);
            }
        }
        updateChefMode();
    }
    
    // Initialize voice recognition with AI
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onstart = () => {
            console.log('Voice recognition started');
            document.getElementById('voiceStatus').textContent = 'üé§ Voice Active';
            document.getElementById('voiceStatus').style.background = '#8fd694';
        };
        
        recognition.onerror = (event) => {
            console.error('Voice recognition error:', event.error);
            document.getElementById('voiceStatus').textContent = 'üé§ Click to Retry';
            document.getElementById('voiceStatus').style.background = '#ff4444';
            
            if (event.error === 'not-allowed') {
                alert('Microphone permission denied. Please allow microphone access and refresh.');
            }
        };
        
        recognition.onend = () => {
            if (chefMode) {
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch (err) {
                        console.log('Could not restart recognition');
                    }
                }, 100);
            }
        };
        
        recognition.onresult = async (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            console.log('Heard:', transcript);
            
            showVoiceIndicator(`Heard: "${transcript}"`);
            
            // Get ingredient list
            const ingredientsList = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item span'))
                .map((el, i) => `${i + 1}. ${el.textContent}`)
                .join('\n');
            
            // Use AI to understand command
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You're a voice assistant for a cooking app. User is on step ${currentStepIndex + 1}/${steps.length}.

Current step: "${steps[currentStepIndex].title} - ${steps[currentStepIndex].text}"

Ingredients:
${ingredientsList}

Steps:
${steps.map((s, i) => `${i + 1}. ${s.title}: ${s.text}`).join('\n')}

User said: "${transcript}"

Return ONLY JSON:
{
  "action": "next_step" | "prev_step" | "go_to_step" | "start_timer" | "read_ingredients" | "read_step" | "toggle_ingredients" | "check_ingredient" | "unknown",
  "step_number": null,
  "ingredient_numbers": [],
  "ingredient_names": [],
  "response_text": "brief response"
}

Examples:
"next" ‚Üí {"action":"next_step","step_number":null,"ingredient_numbers":[],"ingredient_names":[],"response_text":"Moving to next step"}
"what are the first 2 ingredients" ‚Üí {"action":"read_ingredients","step_number":null,"ingredient_numbers":[1,2],"ingredient_names":["Cajun spice","shrimp"],"response_text":"The first 2 ingredients are Cajun spice and shrimp"}
"check off the shrimp" ‚Üí {"action":"check_ingredient","step_number":null,"ingredient_numbers":[2],"ingredient_names":["shrimp"],"response_text":"Checked off shrimp"}
"go to step 3" ‚Üí {"action":"go_to_step","step_number":3,"ingredient_numbers":[],"ingredient_names":[],"response_text":"Going to step 3"}`
                        }]
                    })
                });
                
                const data = await response.json();
                const text = data.content[0].text.trim();
                const cleanText = text.replace(/```json|```/g, "").trim();
                const command = JSON.parse(cleanText);
                
                console.log('AI understood:', command);
                executeVoiceCommand(command);
                
            } catch (err) {
                console.error('AI command processing failed:', err);
                showVoiceIndicator('Sorry, I didn\'t understand that');
            }
        };
    }
    
    function executeVoiceCommand(command) {
        showVoiceIndicator(command.response_text);
        
        switch(command.action) {
            case 'next_step':
                nextStep();
                break;
            case 'prev_step':
                prevStep();
                break;
            case 'go_to_step':
                if (command.step_number && command.step_number >= 1 && command.step_number <= steps.length) {
                    currentStepIndex = command.step_number - 1;
                    updateChefMode();
                    speakCurrentStep();
                }
                break;
            case 'start_timer':
                if (detectedTimers[currentStepIndex] && detectedTimers[currentStepIndex][0]) {
                    startTimer(detectedTimers[currentStepIndex][0].duration_seconds);
                }
                break;
            case 'read_ingredients':
                const ingredientsToRead = command.ingredient_names.join(', ');
                speak(command.response_text);
                break;
            case 'read_step':
                speakCurrentStep();
                break;
            case 'toggle_ingredients':
                toggleIngredientsView();
                break;
            case 'check_ingredient':
                command.ingredient_numbers.forEach(num => {
                    if (num >= 1 && num <= 13) {
                        const items = document.querySelectorAll('#ingredientsList .ingredient-item');
                        const item = items[num - 1];
                        if (item && !item.classList.contains('checked')) {
                            toggleIngredient(item);
                        }
                    }
                });
                updateChefIngredients();
                break;
        }
    }
    
    function showVoiceIndicator(text) {
        const indicator = document.getElementById('voiceIndicator');
        indicator.textContent = text || 'üé§ Listening...';
        indicator.classList.add('active');
        setTimeout(() => {
            indicator.classList.remove('active');
        }, 3000);
    }
    
    function toggleIngredient(element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('checked');
        updateChefIngredients();
    }
    
    function toggleChefIngredient(element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const index = element.dataset.index;
        
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('checked');
        
        // Sync with main ingredient list
        const mainItems = document.querySelectorAll('#ingredientsList .ingredient-item');
        const mainItem = mainItems[index];
        if (mainItem) {
            const mainCheckbox = mainItem.querySelector('input[type="checkbox"]');
            mainCheckbox.checked = checkbox.checked;
            if (checkbox.checked) {
                mainItem.classList.add('checked');
            } else {
                mainItem.classList.remove('checked');
            }
        }
    }
    
    async function toggleChefMode() {
        chefMode = !chefMode;
        const btn = document.getElementById("chefBtn");
        const container = document.getElementById("chefModeContainer");
        
        if (chefMode) {
            btn.classList.add("chef-on");
            container.classList.add("active");
            currentStepIndex = 0;
            
            detectTimersInSteps();
            
            updateChefMode();
            renderStepsPreview();
            updateChefIngredients();
            
            try {
                if ("wakeLock" in navigator) {
                    wakeLock = await navigator.wakeLock.request("screen");
                    console.log("Wake Lock activated!");
                }
            } catch (err) {
                console.log("Wake Lock not available - using video fallback");
                enableVideoWakeLock();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                    console.log('Starting voice recognition...');
                } catch (err) {
                    console.log("Voice recognition error:", err);
                    document.getElementById('voiceStatus').textContent = 'üé§ Click to Enable';
                    document.getElementById('voiceStatus').style.background = '#ffc988';
                }
            } else {
                document.getElementById('voiceStatus').textContent = 'üé§ Not Supported';
                document.getElementById('voiceStatus').style.background = '#666';
            }
            
            speakCurrentStep();
        } else {
            btn.classList.remove("chef-on");
            container.classList.remove("active");
            
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            
            disableVideoWakeLock();
            
            if (recognition) {
                recognition.stop();
            }
            
            resetTimer();
        }
    }
    
    function updateChefMode() {
        const step = steps[currentStepIndex];
        document.getElementById('stepTitle').textContent = `Step ${currentStepIndex + 1}: ${step.title}`;
        document.getElementById('stepText').textContent = step.text;
        document.getElementById('progressText').textContent = `Step ${currentStepIndex + 1} of ${steps.length}`;
        document.getElementById('progressFill').style.width = `${((currentStepIndex + 1) / steps.length) * 100}%`;
        
        document.getElementById('prevBtn').disabled = currentStepIndex === 0;
        document.getElementById('nextBtn').disabled = currentStepIndex === steps.length - 1;
        
        const timerSection = document.getElementById('timerSection');
        const timerButtons = document.querySelector('.timer-buttons');
        
        if (detectedTimers[currentStepIndex]) {
            timerSection.style.display = 'block';
            
            const existingCustom = timerButtons.querySelectorAll('.ai-timer-btn');
            existingCustom.forEach(btn => btn.remove());
            
            detectedTimers[currentStepIndex].forEach(timer => {
                const btn = document.createElement('button');
                btn.className = 'ai-timer-btn';
                btn.textContent = `‚è±Ô∏è ${timer.label}`;
                btn.onclick = () => startTimer(timer.duration_seconds);
                timerButtons.insertBefore(btn, timerButtons.children[0]);
            });
        } else {
            timerSection.style.display = 'none';
        }
        
        resetTimer();
        renderStepsPreview();
    }
    
    function nextStep() {
        if (currentStepIndex < steps.length - 1) {
            currentStepIndex++;
            updateChefMode();
            speakCurrentStep();
        }
    }
    
    function prevStep() {
        if (currentStepIndex > 0) {
            currentStepIndex--;
            updateChefMode();
            speakCurrentStep();
        }
    }
    
    function renderStepsPreview() {
        const container = document.getElementById('stepsPreview');
        container.innerHTML = '';
        
        steps.forEach((step, index) => {
            const div = document.createElement('div');
            div.className = 'step-preview';
            if (index < currentStepIndex) div.classList.add('completed');
            if (index === currentStepIndex) div.classList.add('active');
            div.innerHTML = `<strong>Step ${index + 1}:</strong> ${step.title}`;
            div.onclick = () => {
                currentStepIndex = index;
                updateChefMode();
                speakCurrentStep();
            };
            container.appendChild(div);
        });
    }
    
    function startTimer(seconds) {
        resetTimer();
        timerSeconds = seconds;
        timerRunning = true;
        updateTimerDisplay();
        
        timerInterval = setInterval(() => {
            if (timerRunning && timerSeconds > 0) {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds === 0) {
                    timerRunning = false;
                    playTimerSound();
                    speak('Timer finished!');
                }
            }
        }, 1000);
    }
    
    function pauseTimer() {
        timerRunning = !timerRunning;
        const pauseBtn = document.querySelector('.timer-buttons button:nth-child(4)');
        if (pauseBtn) {
            pauseBtn.textContent = timerRunning ? '‚è∏ Pause' : '‚ñ∂Ô∏è Resume';
        }
    }
    
    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = 0;
        timerRunning = false;
        updateTimerDisplay();
        const pauseBtn = document.querySelector('.timer-buttons button:nth-child(4)');
        if (pauseBtn) {
            pauseBtn.textContent = '‚è∏ Pause';
        }
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timerDisplay').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    
    function playTimerSound() {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(context.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, context.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
        
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + 0.5);
    }
    
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }
    }
    
    function speakCurrentStep() {
        const step = steps[currentStepIndex];
        speak(`Step ${currentStepIndex + 1}: ${step.title}. ${step.text}`);
    }
    
    function retryVoice() {
        if (recognition && chefMode) {
            try {
                recognition.stop();
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } catch (err) {
                console.log('Retry failed:', err);
            }
        }
    }
    
    function toggleIngredientsView() {
        ingredientsVisible = !ingredientsVisible;
        const list = document.getElementById('chefIngredientsList');
        const icon = document.getElementById('ingredientsToggleIcon');
        
        if (ingredientsVisible) {
            list.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            list.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }
    
    function updateChefIngredients() {
        const container = document.getElementById('chefIngredientsContent');
        const ingredients = document.querySelectorAll('#ingredientsList .ingredient-item');
        container.innerHTML = '';
        
        ingredients.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'chef-ingredient-item';
            div.dataset.index = index;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.querySelector('input').checked;
            
            const span = document.createElement('span');
            span.textContent = item.querySelector('span').textContent;
            
            if (item.classList.contains('checked')) {
                div.classList.add('checked');
            }
            
            div.appendChild(checkbox);
            div.appendChild(span);
            div.onclick = () => toggleChefIngredient(div);
            
            container.appendChild(div);
        });
    }
    
    function printRecipe() {
        window.print();
    }
    
    document.getElementById('ingredientsList').addEventListener('change', updateChefIngredients);
</script>

</body>
</html>
