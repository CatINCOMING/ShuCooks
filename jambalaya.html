<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jambalaya Recipe - ShuCooks</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #fafafa; }
        .navbar { display: flex; gap: 20px; padding: 15px; background: #ffffffcc; backdrop-filter: blur(8px); border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .navbar a { padding: 10px 20px; background: #f2f2f2; border-radius: 20px; text-decoration: none; color: #333; font-weight: bold; transition: 0.2s; }
        .navbar a:hover { background: #ffd6a5; }
        .navbar .logo { background: #ffd6a5; }
        .content { padding: 30px; max-width: 900px; margin: auto; }
        .recipe-photo { width: 100%; height: 400px; border-radius: 14px; margin-bottom: 20px; background: linear-gradient(135deg, #ff6b35, #f7931e); display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold; }
        .button-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 18px; border: none; background: #ffe5b4; border-radius: 14px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #ffc988; }
        .chef-on { background: #8fd694 !important; }
        h1 { margin-bottom: 20px; }
        h2 { margin-top: 30px; margin-bottom: 15px; }
        ul, ol { margin-left: 20px; line-height: 1.8; }
        li { margin-bottom: 8px; }
        .ingredient-item { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; }
        .ingredient-item:hover { background: #f0f0f0; }
        .ingredient-item input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .ingredient-item.checked { text-decoration: line-through; opacity: 0.6; }
        .chef-mode-container { display: none; position: fixed; inset: 0; background: #1a1a1a; color: white; z-index: 1000; overflow-y: auto; }
        .chef-mode-container.active { display: block; }
        .chef-mode-header { background: #2a2a2a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; flex-wrap: wrap; gap: 10px; }
        .chef-mode-header h2 { margin: 0; font-size: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .exit-chef-mode { background: #ff4444; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; }
        .chef-mode-content { padding: 20px; max-width: 800px; margin: 0 auto; }
        .progress-bar { background: #333; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background: #8fd694; height: 100%; transition: width 0.3s; }
        .progress-text { text-align: center; color: #999; margin-bottom: 30px; font-size: 14px; }
        .current-step { background: #2a2a2a; padding: 30px; border-radius: 14px; margin-bottom: 20px; border: 3px solid #8fd694; cursor: pointer; transition: 0.2s; }
        .current-step:active { transform: scale(0.98); }
        .step-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #8fd694; }
        .step-text { font-size: 24px; line-height: 1.6; }
        .timer-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; }
        .timer-display { font-size: 48px; font-weight: bold; text-align: center; color: #8fd694; margin: 20px 0; }
        .timer-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .timer-buttons button { background: #444; color: white; padding: 12px 20px; font-size: 16px; }
        .timer-buttons button:hover { background: #555; }
        .chef-navigation { display: flex; gap: 15px; margin-bottom: 20px; }
        .chef-navigation button { flex: 1; padding: 18px; font-size: 18px; background: #444; color: white; }
        .chef-navigation button:hover { background: #555; }
        .chef-navigation button:disabled { opacity: 0.3; cursor: not-allowed; }
        .all-steps-preview { margin-top: 30px; }
        .step-preview { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; opacity: 0.5; cursor: pointer; transition: 0.2s; }
        .step-preview:hover { opacity: 0.8; }
        .step-preview.active { opacity: 1; border: 2px solid #8fd694; }
        .ingredients-toggle { background: #444; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
        .ingredients-list { background: #2a2a2a; padding: 20px; border-radius: 8px; margin-top: 10px; }
        .chef-ingredient-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #444; cursor: pointer; transition: 0.2s; }
        .chef-ingredient-item:hover { background: #333; }
        .chef-ingredient-item input[type="checkbox"] { margin-right: 12px; width: 20px; height: 20px; cursor: pointer; }
        .chef-ingredient-item.checked { text-decoration: line-through; opacity: 0.5; }
        .voice-indicator { position: fixed; bottom: 20px; right: 20px; background: #8fd694; color: #1a1a1a; padding: 15px 20px; border-radius: 30px; font-weight: bold; display: none; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2000; }
        .voice-indicator.active { display: block; }
        .hands-free-badge { display: inline-block; background: #8fd694; color: #1a1a1a; padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        #voiceStatus { display: inline-block; background: #ffc988; color: #1a1a1a; padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #voiceStatus:hover { opacity: 0.8; }
        .ai-timer-btn { background: #8fd694 !important; color: #1a1a1a; font-weight: bold; }
        .commands-help { background: #2a2a2a; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .commands-help h3 { color: #8fd694; margin-bottom: 15px; }
        .commands-help ul { list-style: none; margin: 0; }
        .commands-help li { padding: 8px 0; color: #ccc; }
        .commands-help code { background: #1a1a1a; padding: 3px 8px; border-radius: 4px; color: #8fd694; }
    </style>
</head>
<body>
<nav class="navbar">
    <a href="#" class="logo">ShuCooks</a>
    <a href="#">Home</a>
    <a href="#">Recipes</a>
    <a href="#">Contact</a>
</nav>

<section class="content">
    <h1>Jambalaya (CPK-Style)</h1>
    <div class="recipe-photo">Jambalaya Photo</div>
    
    <div class="button-row">
        <button onclick="printRecipe()">üñ®Ô∏è Print Recipe</button>
        <button id="chefBtn" onclick="toggleChefMode()">üë®‚Äçüç≥ Chef Mode</button>
    </div>
    
    <h2>Ingredients (Serves 4)</h2>
    <div id="ingredientsList">
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>3 tbsp Cajun spice</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>12‚Äì16 shrimp, deveined</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>¬Ω red bell pepper, diced</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>1 jalape√±o, diced</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>¬Ω red onion, diced</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>¬Ω lb cooked linguine</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>1 andouille sausage, sliced</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>1 ¬Ω cups chicken stock</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>1 tbsp tomato sauce</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>¬Ω tsp salt</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>¬º tsp black pepper</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>3 cloves garlic, minced</span></div>
        <div class="ingredient-item" onclick="toggleIngredient(this)"><input type="checkbox"><span>3 tbsp cooking oil</span></div>
    </div>
    
    <h2>Instructions</h2>
    <ol id="instructionsList">
        <li><strong>Season the vegetables:</strong> Mix peppers, onion, garlic, Cajun seasoning, and pepper.</li>
        <li><strong>Sear the shrimp:</strong> Cook 30‚Äì60 seconds per side.</li>
        <li><strong>Cook the sausage:</strong> Saut√© 1 minute.</li>
        <li><strong>Cook the vegetables:</strong> Sear 3‚Äì4 minutes.</li>
        <li><strong>Build the sauce:</strong> Add stock + tomato sauce, simmer 5 minutes.</li>
        <li><strong>Add pasta:</strong> Toss 2‚Äì3 minutes until coated.</li>
    </ol>
</section>

<div id="chefModeContainer" class="chef-mode-container">
    <div class="chef-mode-header">
        <h2>
            <span>üë®‚Äçüç≥ Chef Mode</span>
            <span class="hands-free-badge">üîì Screen Unlocked</span>
            <span id="voiceStatus" onclick="retryVoice()">üé§ Starting...</span>
        </h2>
        <button class="exit-chef-mode" onclick="toggleChefMode()">‚úï Exit</button>
    </div>
    
    <div class="chef-mode-content">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">Step 1 of 6</div>
        
        <div class="ingredients-toggle" onclick="toggleIngredientsView()">
            <strong>üìã Ingredients Checklist</strong> <span id="ingredientsToggleIcon">‚ñº</span>
        </div>
        <div class="ingredients-list" id="chefIngredientsList" style="display: none;">
            <div id="chefIngredientsContent"></div>
        </div>
        
        <div class="current-step" id="currentStep" onclick="nextStep()">
            <div class="step-title" id="stepTitle">Step 1: Season the vegetables</div>
            <div class="step-text" id="stepText">Mix peppers, onion, garlic, Cajun seasoning, and pepper.</div>
            
            <div class="timer-section" id="timerSection" style="display: none;">
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="timer-buttons">
                    <button onclick="startTimer(60)">1 min</button>
                    <button onclick="startTimer(180)">3 min</button>
                    <button onclick="startTimer(300)">5 min</button>
                    <button onclick="pauseTimer()">‚è∏ Pause</button>
                    <button onclick="resetTimer()">üîÑ Reset</button>
                </div>
            </div>
        </div>
        
        <div class="chef-navigation">
            <button onclick="prevStep()" id="prevBtn">‚¨ÖÔ∏è Previous</button>
            <button onclick="nextStep()" id="nextBtn">Next ‚û°Ô∏è</button>
        </div>
        
        <div class="all-steps-preview">
            <h3>All Steps</h3>
            <div id="stepsPreview"></div>
        </div>
        
        <div class="commands-help">
            <h3>üé§ Say "CHEF" first, then your command:</h3>
            <ul>
                <li><code>"Chef, next step"</code></li>
                <li><code>"Chef, what are the first 2 ingredients?"</code></li>
                <li><code>"Chef, check off the shrimp"</code></li>
                <li><code>"Chef, start timer"</code></li>
                <li><code>"Chef, show ingredients"</code></li>
                <li><code>"Chef, go to step 3"</code></li>
            </ul>
            <p style="margin-top: 10px; color: #8fd694;">‚ú® The AI understands natural speech!</p>
        </div>
    </div>
</div>

<div class="voice-indicator" id="voiceIndicator">üé§ Listening...</div>

<script>
const steps = [
    { title: "Season the vegetables", text: "Mix peppers, onion, garlic, Cajun seasoning, and pepper." },
    { title: "Sear the shrimp", text: "Cook 30‚Äì60 seconds per side." },
    { title: "Cook the sausage", text: "Saut√© 1 minute." },
    { title: "Cook the vegetables", text: "Sear 3‚Äì4 minutes." },
    { title: "Build the sauce", text: "Add stock + tomato sauce, simmer 5 minutes." },
    { title: "Add pasta", text: "Toss 2‚Äì3 minutes until coated." }
];

let currentStepIndex = 0, chefMode = false, wakeLock = null, timerInterval = null, timerSeconds = 0, timerRunning = false;
let recognition = null, ingredientsVisible = false, detectedTimers = {}, videoWakeLock = null;
let waitingForCommand = false, commandTimeout = null, recognitionActive = false;

function enableVideoWakeLock() {
    if (videoWakeLock) return;
    videoWakeLock = document.createElement('video');
    videoWakeLock.loop = true; videoWakeLock.muted = true; videoWakeLock.playsInline = true;
    videoWakeLock.style.cssText = 'position:fixed;opacity:0;pointer-events:none;width:1px;height:1px';
    const c = document.createElement('canvas'); c.width = c.height = 1;
    c.getContext('2d').fillRect(0,0,1,1);
    c.toBlob(b => { videoWakeLock.src = URL.createObjectURL(b); videoWakeLock.play().catch(()=>{}); });
    document.body.appendChild(videoWakeLock);
}

function disableVideoWakeLock() { if (videoWakeLock) { videoWakeLock.pause(); videoWakeLock.remove(); videoWakeLock = null; } }

async function detectTimersInSteps() {
    for (let i = 0; i < steps.length; i++) {
        const txt = steps[i].title + ". " + steps[i].text;
        try {
            const r = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514", max_tokens: 500,
                    messages: [{role: "user", content: `Extract time from: "${txt}". Return JSON: {"timers":[{"duration_seconds":45,"label":"avg"}]} or {"timers":[]}`}]
                })
            });
            const d = await r.json();
            const clean = d.content[0].text.replace(/```json|```/g, "").trim();
            const parsed = JSON.parse(clean);
            if (parsed.timers?.length) detectedTimers[i] = parsed.timers;
        } catch(e) { console.log('Timer detect skip', i); }
    }
    if (chefMode) updateChefMode();
}

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = true; recognition.interimResults = false; recognition.lang = 'en-US';
    
    recognition.onstart = () => {
        recognitionActive = true;
        document.getElementById('voiceStatus').textContent = 'üé§ Say "Chef"';
        document.getElementById('voiceStatus').style.background = '#8fd694';
    };
    
    recognition.onerror = (e) => {
        console.error('Recognition error:', e.error);
        recognitionActive = false;
        
        // Don't restart on these errors
        if (e.error === 'no-speech' || e.error === 'aborted' || e.error === 'audio-capture') {
            return;
        }
        
        document.getElementById('voiceStatus').textContent = 'üé§ Click to Retry';
        document.getElementById('voiceStatus').style.background = '#ff4444';
        if (e.error === 'not-allowed') alert('Microphone denied. Allow and refresh.');
    };
    
    recognition.onend = () => {
        recognitionActive = false;
        // Only restart if still in chef mode and not already restarting
        if (chefMode && !recognitionActive) {
            setTimeout(() => { 
                if (chefMode && !recognitionActive) {
                    try { 
                        recognition.start(); 
                    } catch(e) {
                        console.log('Could not restart:', e.message);
                    }
                }
            }, 1000); // Increased delay to 1 second
        }
    };
    
    recognition.onresult = async (e) => {
        const txt = e.results[e.results.length-1][0].transcript.trim();
        const low = txt.toLowerCase();
        console.log('Heard:', txt);
        showVoiceIndicator(`"${txt}"`);
        
        if (!waitingForCommand) {
            if (low.includes('chef')) {
                waitingForCommand = true;
                speak('Yes?');
                showVoiceIndicator('Listening...');
                const idx = low.indexOf('chef');
                const after = txt.slice(idx + 4).trim().replace(/^,|^:/, '').trim();
                if (after && after.length > 3) {
                    if (commandTimeout) clearTimeout(commandTimeout);
                    waitingForCommand = false;
                    await processVoiceCommand(after);
                } else {
                    if (commandTimeout) clearTimeout(commandTimeout);
                    commandTimeout = setTimeout(() => { waitingForCommand = false; showVoiceIndicator('Timed out'); }, 6000);
                }
            }
        } else {
            if (commandTimeout) clearTimeout(commandTimeout);
            waitingForCommand = false;
            await processVoiceCommand(txt);
        }
    };
}

async function processVoiceCommand(cmd) {
    showVoiceIndicator('Processing...');
    const ing = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item span')).map((e,i)=>`${i+1}. ${e.textContent}`).join('\n');
    const stp = steps.map((s,i)=>`${i+1}. ${s.title}: ${s.text}`).join('\n');
    
    try {
        const r = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514", max_tokens: 800,
                messages: [{role: "user", content: `Voice assistant. Step ${currentStepIndex+1}/${steps.length}.
Current: "${steps[currentStepIndex].title} - ${steps[currentStepIndex].text}"
Ingredients:\n${ing}
Steps:\n${stp}
User: "${cmd}"
Return JSON: {"action":"next_step|prev_step|go_to_step|start_timer|read_ingredients|check_ingredient|toggle_ingredients|unknown","step_number":null,"ingredient_numbers":[],"response_text":"text"}`}]
            })
        });
        const d = await r.json();
        const clean = d.content[0].text.replace(/```json|```/g, "").trim();
        const c = JSON.parse(clean);
        console.log('AI:', c);
        executeVoiceCommand(c);
    } catch(e) {
        console.error('AI fail:', e);
        speak("Didn't understand");
        showVoiceIndicator("Error");
    }
}

function executeVoiceCommand(c) {
    if (c.response_text) { speak(c.response_text); showVoiceIndicator(c.response_text); }
    
    if (c.action === 'next_step') nextStep();
    else if (c.action === 'prev_step') prevStep();
    else if (c.action === 'go_to_step' && c.step_number >= 1 && c.step_number <= steps.length) {
        currentStepIndex = c.step_number - 1; updateChefMode(); speakCurrentStep();
    } else if (c.action === 'start_timer') {
        if (detectedTimers[currentStepIndex]?.[0]) startTimer(detectedTimers[currentStepIndex][0].duration_seconds);
    } else if (c.action === 'read_ingredients' && c.ingredient_numbers?.length) {
        const items = document.querySelectorAll('#ingredientsList .ingredient-item span');
        const txt = c.ingredient_numbers.map(n => items[n-1]?.textContent).filter(Boolean).join(', ');
        speak(txt || c.response_text);
    } else if (c.action === 'check_ingredient' && c.ingredient_numbers?.length) {
        const items = document.querySelectorAll('#ingredientsList .ingredient-item');
        c.ingredient_numbers.forEach(n => {
            const it = items[n-1];
            if (it && !it.classList.contains('checked')) toggleIngredient(it);
        });
        updateChefIngredients();
    } else if (c.action === 'toggle_ingredients') toggleIngredientsView();
}

function showVoiceIndicator(t) {
    const el = document.getElementById('voiceIndicator');
    el.textContent = t || 'üé§ Listening...';
    el.classList.add('active');
    setTimeout(() => el.classList.remove('active'), 3000);
}

function toggleIngredient(el) {
    const cb = el.querySelector('input[type="checkbox"]');
    cb.checked = !cb.checked;
    el.classList.toggle('checked');
    updateChefIngredients();
}

function toggleChefIngredient(el) {
    const cb = el.querySelector('input[type="checkbox"]');
    const idx = parseInt(el.dataset.index, 10);
    cb.checked = !cb.checked;
    el.classList.toggle('checked');
    const main = document.querySelectorAll('#ingredientsList .ingredient-item')[idx];
    if (main) {
        main.querySelector('input').checked = cb.checked;
        main.classList.toggle('checked', cb.checked);
    }
}

function toggleIngredientsView() {
    ingredientsVisible = !ingredientsVisible;
    const list = document.getElementById('chefIngredientsList');
    const icon = document.getElementById('ingredientsToggleIcon');
    list.style.display = ingredientsVisible ? 'block' : 'none';
    icon.textContent = ingredientsVisible ? '‚ñ≤' : '‚ñº';
}

async function toggleChefMode() {
    chefMode = !chefMode;
    const btn = document.getElementById('chefBtn');
    const cont = document.getElementById('chefModeContainer');
    
    if (chefMode) {
        btn.classList.add('chef-on'); cont.classList.add('active');
        currentStepIndex = 0;
        detectTimersInSteps(); updateChefMode(); renderStepsPreview(); updateChefIngredients();
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) { enableVideoWakeLock(); }
        if (recognition) try { recognition.start(); } catch(e) { document.getElementById('voiceStatus').textContent = 'üé§ Click'; }
        speakCurrentStep();
    } else {
        btn.classList.remove('chef-on'); cont.classList.remove('active');
        try { if (wakeLock) { wakeLock.release(); wakeLock = null; } } catch(e) {}
        disableVideoWakeLock();
        if (recognition) recognition.stop();
        resetTimer();
    }
}

function updateChefMode() {
    const s = steps[currentStepIndex];
    document.getElementById('stepTitle').textContent = `Step ${currentStepIndex+1}: ${s.title}`;
    document.getElementById('stepText').textContent = s.text;
    document.getElementById('progressText').textContent = `Step ${currentStepIndex+1} of ${steps.length}`;
    document.getElementById('progressFill').style.width = `${((currentStepIndex+1)/steps.length)*100}%`;
    document.getElementById('prevBtn').disabled = currentStepIndex === 0;
    document.getElementById('nextBtn').disabled = currentStepIndex === steps.length - 1;
    
    const ts = document.getElementById('timerSection');
    const tb = document.querySelector('.timer-buttons');
    if (detectedTimers[currentStepIndex]) {
        ts.style.display = 'block';
        tb.querySelectorAll('.ai-timer-btn').forEach(b => b.remove());
        detectedTimers[currentStepIndex].forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'ai-timer-btn';
            btn.textContent = `‚è±Ô∏è ${t.label}`;
            btn.onclick = () => startTimer(t.duration_seconds);
            tb.insertBefore(btn, tb.firstChild);
        });
    } else ts.style.display = 'none';
    
    resetTimer(); renderStepsPreview();
}

function nextStep() { if (currentStepIndex < steps.length - 1) { currentStepIndex++; updateChefMode(); speakCurrentStep(); } }
function prevStep() { if (currentStepIndex > 0) { currentStepIndex--; updateChefMode(); speakCurrentStep(); } }

function renderStepsPreview() {
    const c = document.getElementById('stepsPreview'); c.innerHTML = '';
    steps.forEach((s, i) => {
        const d = document.createElement('div'); d.className = 'step-preview';
        if (i === currentStepIndex) d.classList.add('active');
        d.innerHTML = `<strong>Step ${i+1}:</strong> ${s.title}`;
        d.onclick = () => { currentStepIndex = i; updateChefMode(); speakCurrentStep(); };
        c.appendChild(d);
    });
}

function startTimer(sec) {
    resetTimer(); timerSeconds = sec; timerRunning = true; updateTimerDisplay();
    timerInterval = setInterval(() => {
        if (timerRunning && timerSeconds > 0) { timerSeconds--; updateTimerDisplay(); if (timerSeconds === 0) { timerRunning = false; playTimerSound(); speak('Done!'); } }
    }, 1000);
}

function pauseTimer() {
    timerRunning = !timerRunning;
    const pb = document.querySelector('.timer-buttons button:nth-child(4)');
    if (pb) pb.textContent = timerRunning ? '‚è∏ Pause' : '‚ñ∂Ô∏è Resume';
}

function resetTimer() {
    clearInterval(timerInterval); timerSeconds = 0; timerRunning = false; updateTimerDisplay();
    const pb = document.querySelector('.timer-buttons button:nth-child(4)');
    if (pb) pb.textContent = '‚è∏ Pause';
}

function updateTimerDisplay() {
    const m = Math.floor(timerSeconds / 60), s = timerSeconds % 60;
    document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function playTimerSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.frequency.value = 800; osc.type = 'sine';
        g.gain.setValueAtTime(0.3, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
    } catch(e) { console.log('Sound fail'); }
}

function speak(txt) {
    if ('speechSynthesis' in window && txt) {
        const u = new SpeechSynthesisUtterance(txt);
        u.rate = 0.9;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
    }
}

function speakCurrentStep() {
    const s = steps[currentStepIndex];
    speak(`Step ${currentStepIndex+1}: ${s.title}. ${s.text}`);
}

function retryVoice() {
    if (recognition && chefMode) {
        try {
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
        } catch(e) { console.log('Retry fail'); }
    }
}

function updateChefIngredients() {
    const c = document.getElementById('chefIngredientsContent');
    c.innerHTML = '';
    document.querySelectorAll('#ingredientsList .ingredient-item').forEach((it, i) => {
        const d = document.createElement('div');
        d.className = 'chef-ingredient-item';
        d.dataset.index = i;
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!it.querySelector('input').checked;
        const sp = document.createElement('span');
        sp.textContent = it.querySelector('span').textContent;
        if (it.classList.contains('checked')) d.classList.add('checked');
        d.appendChild(cb); d.appendChild(sp);
        d.onclick = () => toggleChefIngredient(d);
        c.appendChild(d);
    });
}

function printRecipe() { window.print(); }

document.getElementById('ingredientsList').addEventListener('change', updateChefIngredients);
</script>
</body>
</html>
